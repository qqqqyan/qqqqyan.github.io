---
layout: post
title: "【性能案例】活动页面"
author: "qqqqyan"
tags: 性能
comments: 'Webp, aspect-ratio, ache, main-thread'
---

# 【性能案例】活动页面

## 测量：Lighthouse
1. Minimize main-thread work
2. Reduce JavaScript execution time
3. Serve static assets with an efficient cache policy
4. Serve images in next-gen formats 
5. Image elements have explicit width and height

## 优化步骤：
1. 主线程情况：
   把按用时长短排序的表格换成主线程运作顺序排序的表格，如下
    | Category | Time Spent | 状况 |
    |  ----  | ----  |
    | Parse HTML & CSS | 23 ms |
    | Script Evaluation | 4,722 ms | 它和“Script Parsing & Compilation”的差距太大了，有可能是因为数据处理复杂 |
    | Script Parsing & Compilation | 34 ms |
    | Style & Layout | 783 ms | 相比以前看到的数据，过于长了 |
    | Rendering | 538 ms | 相比以前看到的数据，过于长了 |
    | Other | 1,627 ms |
    | Garbage Collection | 16 ms |

  从View Trace入口，进入Performance具体看看哪里有问题：
  1. 项目使用了无缝滚动的组件库，导致了火焰图黄色部分很多：应该不用每次都进行大量运算：
  2. 到LCP之前，空闲时间很多，查看表格：
    | Category | Time Spent | 状况 |
    |  ----  | ----  |
    | Loading | 21 ms |
    | Scripting | 1128ms |
    | Rendering | 491 ms |
    | Painting | 156 ms |
    | System | 511 ms |
    | Idle | 3681 ms | 第一批文件接收得太慢，导致空闲时间很多 |
    | Total| 5988 ms | 

1. 探索Webp图片使用可能性：
   ```html
   <picture>
    <source srcset="hello.avif" type="image/avif">
    <source srcset="hello.webp" type="image/webp">
    <img src="hello.jpeg">
  </picture>
   ```
   但是picture、source的兼容性不好
1. 设置宽高，尽管图片比例拉伸，也比**重新计算、布局、渲染**样式要好（保持图片比例的css属性兼容性不好
2. 缓存策略：
   目前是启动式缓存，
   探索其他缓存方式：